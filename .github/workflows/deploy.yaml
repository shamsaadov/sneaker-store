name: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ

on:
  workflow_dispatch:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main, feature/* ]

jobs:
  gather-facts:
    runs-on: ubuntu-latest
    name: Ð¡Ð±Ð¾Ñ€ Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²
    continue-on-error: false
    steps:
      - name: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¹ Ð²ÐµÑ‚ÐºÐ¸
        run: echo "BRANCH_NAME=${{ inputs.branch != '' && inputs.branch || github.head_ref || github.ref_name }}" >> "$GITHUB_ENV"

      - name: ÐŸÐ¾Ð´Ñ‚ÑÐ³Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð°
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST }}
          username: ${{ vars.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: BRANCH_NAME
          script: |
            bash -lc '
            
              echo "Cloning repo (if not exists)"
              git clone git@github.com:shamsaadov/steepstep.git /var/lib/sneaker-store 2> /dev/null
            
              echo "ðŸ”„ Pulling branch latest changes..."
              cd /var/lib/sneaker-store
              git switch "$BRANCH_NAME"
              git restore --staged .
              git restore .
              git pull
            '

  deploy-backend:
    runs-on: ubuntu-latest
    name: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð±ÑÐºÐµÐ½Ð´Ð°
    needs: gather-facts
    continue-on-error: false

    steps:
      - name: Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ .env Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
        uses: SpicyPizza/create-envfile@v2
        with:
          envkey_NODE_ENV: ${{ vars.NODE_ENV }}
          envkey_JWT_SECRET: ${{ vars.JWT_SECRET }}
          envkey_JWT_EXPIRES_IN: ${{ vars.JWT_EXPIRES_IN }}
          envkey_PORT: ${{ vars.PORT }}
          envkey_PRODUCTION_URL: ${{ vars.PRODUCTION_URL }}
          envkey_DB_HOST: ${{ vars.DB_HOST }}
          envkey_DB_PORT: ${{ vars.DB_PORT }}
          envkey_DB_NAME: ${{ vars.DB_NAME }}
          envkey_DB_USER: ${{ vars.DB_USER }}
          envkey_DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          envkey_DB_SSL: ${{ vars.DB_SSL_ENABLED }}
          file_name: sneaker-store-env
          fail_on_empty: true

      - name: Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° .env Ñ‡ÐµÑ€ÐµÐ· ssh
        uses: appleboy/scp-action@v0.1.7
        with:
          host:     ${{ vars.SSH_HOST }}
          username: ${{ vars.SSH_USERNAME }}
          key:      ${{ secrets.SSH_PRIVATE_KEY }}
          source:   "sneaker-store-env"
          target:   "/var/lib/sneaker-store/server"
          debug: 'true'

      - name: Ð”ÐµÐ¿Ð»Ð¾Ð¹ backend-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð½Ð° VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST }}
          username: ${{ vars.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            bash -lc '
            
              echo "Entering into application folder"
              cd /var/lib/sneaker-store/server
              mv sneaker-store-env .env
            
              export NVM_DIR="$HOME/.nvm"
              if [ -s "$NVM_DIR/nvm.sh" ]; then
                . "$NVM_DIR/nvm.sh"
              else
                echo "ðŸ”§ nvm not found â€” installing it"
                curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
                . "$NVM_DIR/nvm.sh"
              fi
            
              echo "ðŸ”¨ Building and deploying..."
              echo "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹"
              nvm install 22
              nvm use 22
              npm i -g bun
              
              npm ci
            
              echo "ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ"
              bunx kill-port 3001
              nohup npm run start > server.log 2>&1 < /dev/null & disown
            
              echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!"
            '

  deploy-frontend:
    runs-on: ubuntu-latest
    name: Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ñ„Ñ€Ð¾Ð½Ñ‚ÐµÐ½Ð´Ð°
    needs: [gather-facts, deploy-backend]

    steps:
      - name: Ð”ÐµÐ¿Ð»Ð¾Ð¹ frontend-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð½Ð° VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ vars.SSH_HOST }}
          username: ${{ vars.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            bash -lc '
              echo "Ð—Ð°Ñ…Ð¾Ð´Ð¸Ð¼ Ð² Ð¿Ð°Ð¿ÐºÑƒ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ"
              cd /var/lib/sneaker-store

              export NVM_DIR="/root/.nvm"
              if [ -s "$NVM_DIR/nvm.sh" ]; then
                . "$NVM_DIR/nvm.sh"
              else
                echo "ðŸ”§ nvm not found â€” installing it"
                curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
                . "$NVM_DIR/nvm.sh"
              fi

              echo "ðŸ”¨ Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ"
              nvm install 22
              nvm use 22
              npx bun install
              npx bun run build

              systemctl restart nginx

              echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½!"
            '